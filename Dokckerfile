FROM node:20-bullseye-slim AS base

FROM base AS builder

WORKDIR /workspace/blog_client

RUN apt-get update && apt-get upgrade -y
COPY blog_client/package.json blog_client/package-lock* ./

COPY blog_client/src ./src
COPY blog_client/public ./public
COPY blog_client/tsconfig.json blog_client/*.js ./

RUN npm install

# Next.jsによってテレメトリデータを収集するのを無効にする
ARG NEXT_TELEMETRY_DISABLED=1
ENV NEXT_TELEMETRY_DISABLED=$NEXT_TELEMETRY_DISABLED

RUN  npm run build

FROM base AS runner

WORKDIR /workspace/blog_client

USER node

COPY --from=builder /workspace/blog_client/public ./public

# 自動的に出力トレースを活用することで、イメージサイズを削減する
# https://nextjs.org/docs/advanced-features/output-file-tracing
COPY --from=builder --chown=node:node /workspace/blog_client/.next/standalone ./
COPY --from=builder --chown=node:node /workspace/blog_client/.next/static ./.next/static

# Next.jsによってテレメトリデータを収集するのを無効にする
ENV NEXT_TELEMETRY_DISABLED=$NEXT_TELEMETRY_DISABLED

# 注意: ポートのマッピングはdocker-composeで行うため、設定しない

CMD ["node", "server.js"]